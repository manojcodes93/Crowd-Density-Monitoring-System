<!DOCTYPE html>
<html>
<head>
    <title>AI Crowd Monitoring</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

<div class="container">

    <aside class="sidebar">
        <div class="logo">CrowdAI</div>
    </aside>

    <main class="main">

        <div class="topbar">
            <h1>AI Crowd Monitoring</h1>
            <div class="status online">‚óè System Online</div>
        </div>

        <div id="alertBox"></div>

        <!-- ================= STATS ================= -->
        <div class="stats">
            <div class="card">
                <h2 id="totalCount">0</h2>
                <p>Total Crowd</p>
            </div>
            <div class="card">
                <h2 id="zoneA">0</h2>
                <p>Zone A</p>
            </div>
            <div class="card">
                <h2 id="zoneB">0</h2>
                <p>Zone B</p>
            </div>
            <div class="card">
                <h2 id="zoneC">0</h2>
                <p>Zone C</p>
            </div>
            <div class="card">
                <h2 id="zoneD">0</h2>
                <p>Zone D</p>
            </div>
        </div>

        <!-- ================= LIVE STREAM ================= -->
        <div class="heatmap-section">
            <div class="heatmap-box">
                <img src="/video" width="100%" height="100%">
            </div>

            <div class="prediction-box">
                <h3>Prediction (Next 5s)</h3>
                <div class="highlight" id="predictionValue">0</div>
            </div>
        </div>

        <br><br>

        <!-- ================= ANALYTICS SECTION ================= -->
        <h2>üìä Live Analytics</h2>

        <canvas id="crowdChart" height="80"></canvas>
        <br>
        <canvas id="zoneChart" height="80"></canvas>

    </main>

</div>

<script>

let crowdChart;
let zoneChart;

async function fetchStats() {
    try {
        const response = await fetch("/stats");
        const data = await response.json();

        document.getElementById("totalCount").innerText = data.total;
        document.getElementById("zoneA").innerText = data.zoneA;
        document.getElementById("zoneB").innerText = data.zoneB;
        document.getElementById("zoneC").innerText = data.zoneC;
        document.getElementById("zoneD").innerText = data.zoneD;
        document.getElementById("predictionValue").innerText = data.prediction;

        const alertBox = document.getElementById("alertBox");

        if (data.alert) {
            alertBox.innerHTML = `<div class="alert danger">
                ‚ö† Overcrowding Predicted!
            </div>`;
        } else {
            alertBox.innerHTML = "";
        }

    } catch (error) {
        console.log("Stats API error");
    }
}

async function loadAnalytics() {
    const response = await fetch("/log-data");
    const data = await response.json();

    const timestamps = data.map(d => d.timestamp);
    const totals = data.map(d => Number(d.total));
    const zoneA = data.map(d => Number(d.zoneA));
    const zoneB = data.map(d => Number(d.zoneB));
    const zoneC = data.map(d => Number(d.zoneC));
    const zoneD = data.map(d => Number(d.zoneD));

    if (crowdChart) crowdChart.destroy();
    if (zoneChart) zoneChart.destroy();

    crowdChart = new Chart(document.getElementById("crowdChart"), {
        type: "line",
        data: {
            labels: timestamps,
            datasets: [{
                label: "Total Crowd",
                data: totals,
                borderColor: "#00f5ff",
                fill: false,
                tension: 0.2
            }]
        }
    });

    zoneChart = new Chart(document.getElementById("zoneChart"), {
        type: "bar",
        data: {
            labels: ["Zone A", "Zone B", "Zone C", "Zone D"],
            datasets: [{
                label: "Latest Zone Distribution",
                data: [
                    zoneA[zoneA.length - 1] || 0,
                    zoneB[zoneB.length - 1] || 0,
                    zoneC[zoneC.length - 1] || 0,
                    zoneD[zoneD.length - 1] || 0
                ],
                backgroundColor: [
                    "#00f5ff",
                    "#facc15",
                    "#ff4d4d",
                    "#00ff88"
                ]
            }]
        }
    });
}

setInterval(fetchStats, 1000);
setInterval(loadAnalytics, 5000);

fetchStats();
loadAnalytics();

</script>

</body>
</html>