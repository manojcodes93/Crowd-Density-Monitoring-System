<!DOCTYPE html>
<html>
<head>
    <title>AI Crowd Monitoring</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

<div class="container">

    <aside class="sidebar">
        <div class="logo">CrowdAI</div>
    </aside>

    <main class="main">

        <div class="topbar">
            <h1>AI Crowd Monitoring</h1>
            <div class="status online">‚óè System Online</div>
        </div>

        <div class="stats">
            <div class="card"><h2 id="totalCount">0</h2><p>Total</p></div>
            <div class="card"><h2 id="zoneA">0</h2><p>Zone A</p></div>
            <div class="card"><h2 id="zoneB">0</h2><p>Zone B</p></div>
            <div class="card"><h2 id="zoneC">0</h2><p>Zone C</p></div>
            <div class="card"><h2 id="zoneD">0</h2><p>Zone D</p></div>
        </div>

        <div class="heatmap-section">
            <div class="heatmap-box">
                <img src="/video" width="100%" height="100%">
            </div>
            <div class="prediction-box">
                <h3>Prediction</h3>
                <div class="highlight" id="predictionValue">0</div>
            </div>
        </div>

        <br><br>

        <h2>üìä Live Analytics</h2>

        <canvas id="crowdChart"></canvas>
        <br>
        <canvas id="zoneChart"></canvas>

    </main>

</div>

<script>
document.addEventListener("DOMContentLoaded", function () {

    let crowdChart = null;
    let zoneChart = null;

    async function fetchStats() {
        try {
            const response = await fetch("/stats");
            const data = await response.json();

            document.getElementById("totalCount").innerText = data.total;
            document.getElementById("zoneA").innerText = data.zoneA;
            document.getElementById("zoneB").innerText = data.zoneB;
            document.getElementById("zoneC").innerText = data.zoneC;
            document.getElementById("zoneD").innerText = data.zoneD;
            document.getElementById("predictionValue").innerText = data.prediction;
        } catch (err) {
            console.error("Stats error:", err);
        }
    }

    async function loadAnalytics() {
        try {
            const response = await fetch("/log-data");
            const data = await response.json();

            if (!Array.isArray(data) || data.length === 0) {
                console.log("No analytics data yet.");
                return;
            }

            const recent = data.slice(-20);

            const labels = recent.map(d => d.timestamp);
            const totals = recent.map(d => d.total);

            const last = recent[recent.length - 1];

            const ctx1 = document.getElementById("crowdChart").getContext("2d");
            const ctx2 = document.getElementById("zoneChart").getContext("2d");

            if (crowdChart) crowdChart.destroy();
            if (zoneChart) zoneChart.destroy();

            crowdChart = new Chart(ctx1, {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [{
                        label: "Total Crowd",
                        data: totals,
                        borderColor: "#00f5ff",
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { precision: 0 }
                        }
                    }
                }
            });

            zoneChart = new Chart(ctx2, {
                type: "bar",
                data: {
                    labels: ["Zone A", "Zone B", "Zone C", "Zone D"],
                    datasets: [{
                        label: "Latest Zones",
                        data: [
                            last.zoneA,
                            last.zoneB,
                            last.zoneC,
                            last.zoneD
                        ],
                        backgroundColor: [
                            "#00f5ff",
                            "#facc15",
                            "#ff4d4d",
                            "#00ff88"
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { precision: 0 }
                        }
                    }
                }
            });

        } catch (err) {
            console.error("Analytics error:", err);
        }
    }

    fetchStats();
    loadAnalytics();

    setInterval(fetchStats, 1000);
    setInterval(loadAnalytics, 5000);

});
</script>

</body>
</html>